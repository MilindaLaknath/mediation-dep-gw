<?xml version="1.0" encoding="UTF-8"?>
<sequence name="sendSmsOutSeq" trace="disable" xmlns="http://ws.apache.org/ns/synapse">

    <property name="responseResourceUrl" expression="json-eval($.outboundSMSMessageRequest.resourceURL)"/>
    <property name="operatorRequestId" expression="fn:substring-after(get-property('responseResourceUrl'), '/requests/')" />
    <filter source="boolean(get-property('operatorRequestId'))" regex="false">
        <then>
            <log level="custom">
                <property name="ERROR" value="Unable extract operator request id (plugin_requestid) from response"/>
            </log>
        </then>
    </filter>

    <property name="SEND_SMS_OPERATOR_REQUEST_ID" expression="get-property('operatorRequestId')" action="set" scope="default"/>

    <property name="smsRetrieveResourceUrl" expression="fn:concat(get-property('SEND_SMS_RESOURCE_URL_PREFIX'), '/requests/', get-property('REQUEST_ID'))" scope="default" />
    <property name="smsDeliveryInfoResourceUrl" expression="fn:concat(get-property('smsRetrieveResourceUrl'), '/deliveryInfos')" scope="default" />

    <filter source="boolean(get-property('originalNotifyURL'))" regex="true">
        <then>
            <class name="com.wso2telco.dep.common.mediation.UtilMediator">
                <property name="propertyValue" value="singlePropertyReplacement"/>
                <property name="propertyName" value="notifyURL"/>
                <property name="propertyPath" value="payload.outboundSMSMessageRequest.receiptRequest.notifyURL"/>
                <property name="msgContextProperty" value="originalNotifyURL"/>
            </class>
        </then>
    </filter>

    <class name="com.wso2telco.dep.common.mediation.UtilMediator">
        <property name="propertyValue" value="singlePropertyReplacement"/>
        <property name="propertyName" value="resourceURL"/>
        <property name="propertyPath" value="payload.outboundSMSMessageRequest.resourceURL"/>
        <property name="msgContextProperty" value="smsRetrieveResourceUrl"/>
    </class>

    <class name="com.wso2telco.dep.common.mediation.UtilMediator">
        <property name="propertyValue" value="singlePropertyReplacement"/>
        <property name="propertyName" value="resourceURL"/>
        <property name="propertyPath" value="payload.outboundSMSMessageRequest.deliveryInfoList.resourceURL"/>
        <property name="msgContextProperty" value="smsDeliveryInfoResourceUrl"/>
    </class>

    <class name="com.wso2telco.dep.mediator.impl.smsmessaging.SendSMSRequestIdPersistMediator"/>
</sequence>
